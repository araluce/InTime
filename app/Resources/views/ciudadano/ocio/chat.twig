{% extends "base.html.twig" %}

{% block header %}
    {% include "ciudadano/header.html.twig" %}
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <style>
        .navbar .navbar-default .navbar-fixed-top{
            display: none;
        } 
        #pagetwo{
            height: 100%;
        }
        #pagetwo .ui-header {
            height : 200px;
            padding: 40px;
        }        
        #pagetwo .ui-content {
            position : absolute;
            top      : 200px;
            bottom   : 200px;
            right    : 0;
            left     : 0;
            font-size: 45px;
            background: url({{ asset('fondo308x512.png')}});
            background-size: auto 50vh;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }
        #pagetwo .ui-footer {
            position : absolute;
            bottom   : 0;
            left     : 0;
            width    : 100%;
            height   : 200px;
            padding-left:  40px;
            padding-right: 40px;
        }
        .ui-header .ui-btn, 
        .ui-footer .ui-btn{
            background-color: #337ab7;
            border-color: #2e6da4;
            color: white;
            font-size: 50px;
        }
        #panel-chat-descripcion img{
            height: 130px;
            width: 130px;
            float:left;
        }
        .ui-header h1{
            padding-left: 10px;
            font-size: 50px;
            float: left;
        }
        .ui-navbar li .ui-btn {
            font-size: 40px;
            background-color: #337ab7;
            border-color: #2e6da4;
            color: white;
        }
        #panel-envio textarea{
            width: 60%;
            float: left;
            font-size: 55px;
        }
        #panel-envio button{
            width: 35%;
            float:right;
        }
        #pageone .ui-content ul li a{
            font-size: 55px;
        }
        .ui-filterable input{
            font-size: 45px;
        }
        .img-chat{
            border-radius: 90px;
            border-bottom-left-radius: 0px;
        }
        #image{
            margin: 1%;
            height: 160px;
            width: 160px;
        }
        .mi-chat,
        .otro-chat{
            padding: 1% 4%; 
            /*color:black; */
            color: white;
            background-color: #337ab7;
            border-radius:50px;
            min-width: 50%;
        }
        .mi-chat{
            float:right; 
            /*background-color: #EBF8A4;*/
            border-bottom-right-radius: 0px;
        }
        .otro-chat{
            float:left; 
            /*background-color: #FFC0CB;*/
            border-bottom-left-radius: 0px;
        }

        .ui-listview>.ui-li-has-thumb>.ui-btn, .ui-listview>.ui-li-static.ui-li-has-thumb {
            padding-left: 3.25em;
        }
        #pagetwo .ui-content small{
            font-size: 25px;
            /*color: #3D66A2;*/
            color: white;
        }
        @media (min-width: 1200px){
            #pagetwo .ui-header {
                height : 100px;
                padding: 10px;
            }        
            #pagetwo .ui-content {
                position : absolute;
                top      : 100px;
                bottom   : 100px;
                font-size: 18px;
            }
            #pagetwo .ui-footer {
                width    : 100%;
                height   : 100px;
            }
            #pagetwo .ui-header .ui-btn, 
            #pagetwo .ui-footer .ui-btn{
                font-size: 20px;
            }
            #panel-chat-descripcion img{
                height: 70px;
                width: 70px;
            }
            #pagetwo .ui-header h1{
                font-size: 20px;
            }
            #panel-envio textarea{
                width: 70%;
                font-size: 25px;
            }
            #panel-envio button{
                width: 25%;
            }
            #pageone .ui-content ul li a{
                font-size: 25px;
            }
            .ui-filterable input{
                font-size: 25px;
            }
            #image{
                height: 70px;
                width: 70px;
            }
            .ui-navbar li .ui-btn {
                font-size: 12.5px;
            }
            .mi-chat,
            .otro-chat{
                padding: 1%;
                border-radius:30px;
            }
            #pagetwo .ui-content small{
                font-size: 13px;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div data-role="page" id="pageone">
        <div data-role="content" data-position="fixed">
            <form class="ui-filterable">
                <input id="myFilter" data-type="search" placeholder="Buscar ciudadano">
            </form>
            <ul data-role="listview" data-filter="true" data-input="#myFilter" data-inset="true" >
                {% if DISTRITOS is not null %}
                    {% for DISTRITO in DISTRITOS %}
                        <li onclick="abrir_chat(null, {{ DISTRITO.getIdUsuarioDistrito() }});">
                            <a href="#pagetwo">{{ DISTRITO.getNombre() }}</a>
                        </li>
                    {% endfor %}
                {% endif %}
                {% if CIUDADANOS is not null %}
                    {% for CIUDADANO in CIUDADANOS %}
                        <li onclick="abrir_chat({{ CIUDADANO.getIdUsuario() }}, null);">
                            <a href="#pagetwo">
                                {% if CIUDADANO.getImagen() is not null%}
                                    <img id="image"
                                         src="{{ asset('images/users/' ~ CIUDADANO.getDni() ~ '/' ~ CIUDADANO.getImagen() ) }}"
                                         class="img-chat"/>
                                {% else %}
                                    <img id="image"
                                         src="{{ asset('images/fotos-usuarios/default.jpg') }}"
                                         class="img-chat"/>
                                {% endif %}
                                {{ CIUDADANO.getSeudonimo() }}
                            </a>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
        <div data-role="footer" data-position="fixed" id="panel-envio">
            <div data-role="navbar" class="ui-navbar" role="navigation">
                <ul class="ui-grid-b">
                    <li class="ui-block-b"><a href="/ciudadano/ocio/amigos" data-icon="arrow-r" class="ui-link ui-btn ui-icon-arrow-r ui-btn-icon-top">Vover</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div data-role="page" id="pagetwo">
        <div data-role="header" data-position="fixed">
            <div id="panel-chat-descripcion"></div>
            <a href="#pageone" class="ui-btn-right">Volver</a>
        </div>
        <div data-role="content" data-position="fixed" id="panel-chat"></div>
        <div data-role="footer" data-position="fixed" id="panel-envio">
            <textarea class="ui-input-text ui-body-a ui-corner-all ui-shadow-inset" id="mensaje" style="resize:none;"></textarea>
            <button id="enviar" class="btn btn-primary">
                Enviar
            </button>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js">
    </script>
    <script>
        chat_actual = null;
        chat_grupo_actual = null;
        offset = 0;
        $(document).ready(function () {
            setInterval(function () {
                abrir_chat(chat_actual, chat_grupo_actual);
            }, 6000);
        });
        function abrir_chat(id_usuario, id_grupo) {
            if (id_usuario !== null) {
                chat_actual = id_usuario;
                chat_grupo_actual = null;
                var url = '/ciudadano/getChat/' + chat_actual + '/' + null + '/' + offset;
            } else if (id_grupo !== null) {
                chat_grupo_actual = id_grupo;
                chat_actual = null;
                var url = '/ciudadano/getChat/' + null + '/' + chat_grupo_actual + '/' + offset;
            }

            if (chat_actual !== null) {
                var url = '/ciudadano/getChat/' + chat_actual + '/' + null + '/' + offset;
            } else if (chat_grupo_actual !== null) {
                var url = '/ciudadano/getChat/' + null + '/' + chat_grupo_actual + '/' + offset;
            }

            if (chat_actual !== null || chat_grupo_actual !== null) {
                $.get(url, function (data) {
                    $('#panel-chat').empty();
                    if (data.estado === 'OK') {
                        console.log(data);
                        contenido = '';
                        $.each(data.mensajes, function (k, v) {
                            contenido += '<div class="col-xs-12" style="margin-top:1%;">';
                            if (v.usuario.alias === v.usuario.mi_alias) {
                                contenido += '<span class="mi-chat">';
                                contenido += '<p></p>';
                            } else {
                                contenido += '<span class="otro-chat">';
                                contenido += '<p><small>@' + v.usuario.alias + '</small></p>';
                            }
                            contenido += v.mensaje;
                            contenido += '<p style="text-align: right;"><small>' + v.fecha.date + '</small></p>';
                            contenido += '</span>';
                            contenido += '</div>';
                        });
                        $('#panel-chat').append(contenido);
                    }
                    $('#panel-chat-descripcion').empty();
                    descripcion = '';
                    if (typeof data.usuario !== 'undefined') {
                        if (data.usuario.imagen !== null) {
                            descripcion += '<img src="{{ asset('images/users/') }}' + data.usuario.dni + '/' + data.usuario.imagen + '" class="img-chat">';
                        } else {
                            descripcion += '<img src="{{ asset('images/fotos-usuarios/default.jpg') }}' + '" class="img-chat">';
                        }
                        descripcion += '<h1>Chat con @' + data.usuario.alias + '</h1>';
                    } else if (typeof data.distrito !== 'undefined') {
                        descripcion += '<h1>' + data.distrito.nombre + '</h1>';
                    }
                    $('#panel-chat-descripcion').append(descripcion);
                    $("#panel-chat").animate({scrollTop: $(document).height() + 1000000}, "slow");
                });
            } else {
                contenido += '<div class="col-lg-12" style="margin-top:1%;">';
                contenido += '<span style="float:left; background-color: #EBF8A4; padding: 1%; color:black;">';
                contenido += 'Para comenzar a chatear con amigos o tu distrito selecciona el contacto en la lista';
                contenido += '</span>';
                contenido += '</div>';
                $('#panel-chat').append(contenido);
            }
        }

        $('#enviar').click(function () {
            var mensaje = $('#mensaje').val();
            if ($.trim(mensaje) !== '') {
                $('#enviar').html('Enviando...');
                $('#mensaje').val('');
                datos = {'id_usuario': chat_actual, 'id_distrito': chat_grupo_actual, 'mensaje': mensaje};
                $.post('/ciudadano/enviarMensajeChat', datos, function (data) {
                    console.log(datos);
                    console.log(data);
                    if (data.estado === 'OK') {
                        if (chat_actual !== null) {
                            abrir_chat(chat_actual, null);
                        } else if (chat_grupo_actual !== null) {
                            abrir_chat(null, chat_grupo_actual);
                        }
                    }
                });
                $('#enviar').html('Enviar');
            }
        });
    </script>
{% endblock %}