{% extends "base.html.twig" %}

{% block header %}
    {% include "ciudadano/header.html.twig" %}
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <style>
        body, input, select, textarea, button, .ui-btn, .btn {
            font-family: "Isocpeur";
        }
        .ui-shadow {
            -webkit-box-shadow: 0 0px 3px rgba(0,0,0,.15);
            -moz-box-shadow: 0 0px 3px rgba(0,0,0,.15);
            box-shadow: 0 0px rgba(0,0,0,.15);
        }
        .ui-corner-all {
            -webkit-border-radius: 0em;
            border-radius: 0em;
        }
        .ui-content{
            font-family: "Isocpeur";
            background-color: #FFFFFF;
        }
        .ui-input-search:after {
            left: .3125em;
            top: 20%;
            margin-top: -7px;
            width: 70px;
            height: 70px;
            filter: Alpha(Opacity=50);
            opacity: .5;
        }
        .ui-alt-icon.ui-icon-search:after, 
        .ui-alt-icon .ui-icon-search:after, 
        .ui-input-search:after,
        .ui-icon-carat-r:after{
            background-size: 65%;
        }
        .ui-btn-icon-left:after, 
        .ui-btn-icon-right:after, 
        .ui-btn-icon-top:after, 
        .ui-btn-icon-bottom:after, 
        .ui-btn-icon-notext:after {
            width: 90px;
            height: 90px;

            /* background-color: #666; */
            background-color: rgba(51, 122, 183,.3);
            background-position: center center;
            background-repeat: no-repeat;
            -webkit-border-radius: 1em;
            border-radius: 1em;
        }
        .ui-btn-icon-right:after {
            right: .5625em;
        }
        .ui-btn-icon-notext:after, 
        .ui-btn-icon-left:after, 
        .ui-btn-icon-right:after {
            top: 25%;
            margin-top: -11px;
        }
        .ui-btn,
        .ui-page-theme-a a{
            font-weight: 300;
        }
        .ui-listview-inset>.ui-li-static, .ui-listview-inset>.ui-li-divider, .ui-listview-inset>li>a.ui-btn {
            border-right-width: 0px;
            border-left-width: 0px;
        }
        .ui-listview>.ui-li-static, .ui-listview>.ui-li-divider, .ui-listview>li>a.ui-btn {
            border-width: 2px 0 0;
            border-style: solid;
        }
        .ui-page-theme-a .ui-btn, html .ui-bar-a .ui-btn, html .ui-body-a .ui-btn, html body .ui-group-theme-a .ui-btn, html head+body .ui-btn.ui-btn-a, .ui-page-theme-a .ui-btn:visited, html .ui-bar-a .ui-btn:visited, html .ui-body-a .ui-btn:visited, html body .ui-group-theme-a .ui-btn:visited, html head+body .ui-btn.ui-btn-a:visited {
            background-color: #FFFFFF;
            border-color: #000000;
            color: #000000;
        }
        ui-first-child .ui-btn,
        ui-first-child .ui-btn.ui-btn-a,
        ui-first-child .ui-btn:visited,
        ui-first-child .ui-btn.ui-btn-a:visited
        {
            border-width: 0px;
        }
        .ui-input-search {
            border-width: 2px;
        }
        .ui-page-theme-a .ui-body-inherit{
            border-color: #000000;
        }
        .navbar .navbar-default .navbar-fixed-top{
            display: none;
        } 
        #pagetwo{
            height: 100%;
        }
        #pagetwo .ui-header {
            height : 200px;
            padding: 40px;
        }        
        #pagetwo .ui-content {
            position : absolute;
            top      : 200px;
            bottom   : 200px;
            right    : 0;
            left     : 0;
            font-size: 45px;
            background: url({{ asset('fondo308x512.png')}});
            background-size: auto 50vh;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }
        #pagetwo .ui-footer {
            position : absolute;
            bottom   : 0;
            left     : 0;
            width    : 100%;
            height   : 200px;
            padding-left:  40px;
            padding-right: 40px;
        }
        .ui-header .ui-btn, 
        .ui-footer .ui-btn{
            background-color: #337ab7;
            border-color: #2e6da4;
            color: white;
            font-size: 50px;
        }
        #panel-chat-descripcion img{
            height: 130px;
            width: 130px;
            float:left;
        }
        .ui-header h1{
            padding-left: 10px;
            font-size: 50px;
            float: left;
        }
        .ui-navbar li .ui-btn {
            font-size: 40px;
            background-color: #337ab7;
            border-color: #2e6da4;
            color: white;
        }
        #panel-envio textarea{
            width: 60%;
            float: left;
            font-size: 45px;
            font-weight: 300;
            resize:none; 
            overflow-y: scroll;
            height: 170px;
            max-height: 170px;
            min-height: 170px;
        }
        #panel-envio button{
            width: 35%;
            float:right;
        }
        #pageone .ui-content ul li a{
            font-size: 55px;
        }
        .ui-filterable input{
            font-size: 45px;
        }
        .img-chat{
            border-radius: 90px;
            border-bottom-left-radius: 0px;
        }
        #image{
            margin: 1%;
            height: 160px;
            width: 160px;
        }
        .mi-chat{
            background-color: rgba(68, 157, 68, 0.7);
        }
        .otro-chat{
            background-color: rgba(201, 48, 48, 0.7);
        }
        .mi-chat,
        .otro-chat{
            padding: 1% 4%; 
            /*color:black; */
            color: white;
            /*background-color: #337ab7;*/
            border-radius:50px;
            min-width: 50%;
        }
        .mi-chat{
            float:right; 
            /*background-color: #EBF8A4;*/
            border-bottom-right-radius: 0px;
        }
        .otro-chat{
            float:left; 
            /*background-color: #FFC0CB;*/
            border-bottom-left-radius: 0px;
        }

        .ui-listview>.ui-li-has-thumb>.ui-btn, .ui-listview>.ui-li-static.ui-li-has-thumb {
            padding-left: 3.6em;
        }
        #pagetwo .ui-content small{
            font-size: 25px;
            /*color: #3D66A2;*/
            color: white;
        }
        #btn-principal-volver{
            border-radius: 0px;
            -webkit-border-radius: 0px;
            font-size: 75px;
        }
        .badge{
            background-color: rgba(51, 122, 183,.3);
            font-size: 45px;
        }
        .ui-listview>.ui-li-divider {
            color: white;
            background-color: #337ab7;
            text-align: center;
            padding: .5em 1.143em;
            font-size: 55px;
            font-weight: 700;
            cursor: default;
            outline: 0;
        }
        @media (min-width: 1200px){
            .ui-btn-icon-left:after, 
            .ui-btn-icon-right:after, 
            .ui-btn-icon-top:after, 
            .ui-btn-icon-bottom:after, 
            .ui-btn-icon-notext:after {
                width: 22px;
                height: 22px;
            }
            .ui-btn-icon-notext:after, 
            .ui-btn-icon-left:after, 
            .ui-btn-icon-right:after {
                top: 50%;
                margin-top: -11px;
            }
            .ui-input-search:after {
                left: .3125em;
                top: 35%;
                margin-top: -7px;
                width: 30px;
                height: 30px;
                filter: Alpha(Opacity=50);
                opacity: .5;
            }
            #pagetwo .ui-header {
                height : 100px;
                padding: 10px;
            }        
            #pagetwo .ui-content {
                position : absolute;
                top      : 100px;
                bottom   : 100px;
                font-size: 18px;
            }
            #pagetwo .ui-footer {
                width    : 100%;
                height   : 100px;
            }
            #pagetwo .ui-header .ui-btn, 
            #pagetwo .ui-footer .ui-btn{
                font-size: 20px;
            }
            #panel-chat-descripcion img{
                height: 70px;
                width: 70px;
            }
            #pagetwo .ui-header h1{
                font-size: 20px;
            }
            #panel-envio textarea{
                width: 70%;
                font-size: 25px;
                height: 80px;
                max-height: 80px;
            }
            #panel-envio button{
                width: 25%;
            }
            #pageone .ui-content ul li a{
                font-size: 25px;
            }
            .ui-filterable input{
                font-size: 25px;
            }
            #image{
                height: 70px;
                width: 70px;
            }
            .ui-navbar li .ui-btn {
                font-size: 12.5px;
            }
            .mi-chat,
            .otro-chat{
                padding: 1%;
                border-radius:30px;
            }
            #pagetwo .ui-content small{
                font-size: 13px;
            }
            #btn-principal-volver{
                font-size: 25px;
            }
            .badge{
                background-color: rgba(51, 122, 183,.3);
                font-size: 25px;
            }
            .ui-listview>.ui-li-divider {
                padding: .5em 1.143em;
                font-size: 17px;
                font-weight: 700;
                cursor: default;
                outline: 0;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div data-role="page" id="pageone">
        <div data-role="content" data-position="fixed">
            <form class="ui-filterable">
                <input id="myFilter" data-type="search" placeholder="Buscar ciudadano">
            </form>
            <ul data-role="listview" data-filter="true" data-input="#myFilter" id="lista-usuarios">
                <li data-role="list-divider">CHAT COMÚN</li>
                <li onclick="abrir_chat(null, null);">
                    <a href="#pagetwo">EL GUETO DE FENI</a>
                </li>

                {% if DISTRITOS is not null %}
                    <li data-role="list-divider">CHAT DE DISTRITO</li>
                        {% for DISTRITO in DISTRITOS %}
                        <li onclick="abrir_chat(null, {{ DISTRITO.getIdUsuarioDistrito() }});">
                            <a href="#pagetwo">{{ DISTRITO.getNombre() }}</a>
                        </li>
                    {% endfor %}
                {% endif %}
                {% if CIUDADANOS is not null %}
                    <li data-role="list-divider">CIUDADANOS</li>
                        {% for CIUDADANO in CIUDADANOS %}
                        <li onclick="abrir_chat({{ CIUDADANO.getIdUsuario() }}, null);">
                            <a href="#pagetwo">
                                {% if CIUDADANO.getImagen() is not null%}
                                    <img id="image"
                                         src="{{ asset('images/users/' ~ CIUDADANO.getDni() ~ '/' ~ CIUDADANO.getImagen() ) }}"
                                         class="img-chat"/>
                                {% else %}
                                    <img id="image"
                                         src="{{ asset('images/fotos-usuarios/default.jpg') }}"
                                         class="img-chat"/>
                                {% endif %}
                                {{ CIUDADANO.getSeudonimo() }}
                                <span class="badge" id="badge-{{ CIUDADANO.getIdUsuario() }}">0</span>
                            </a>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
        <div data-role="footer" data-position="fixed" style="background-color: rgba(255,255,255,0.6);">
            <div class="col-xs-6 col-xs-offset-3 border-radius" style="background-color: #337ab7;" role="none">
                <a role="none" href="/ciudadano/ocio/amigos" rel="external">
                    <button id="btn-principal-volver" role="none" data-enhance="false" class="btn btn-block btn-primary">
                        Volver
                    </button>
                </a>
            </div>
        </div>
    </div>

    <div data-role="page" id="pagetwo">
        <div data-role="header" data-position="fixed">
            <div id="panel-chat-descripcion"></div>
            <a href="#pageone" class="ui-btn-right">Volver</a>
        </div>
        <div data-role="content" data-position="fixed" id="panel-chat"></div>
        <div data-role="footer" data-position="fixed" id="panel-envio">
            <textarea  id="mensaje"></textarea>
            <button id="enviar" class="btn btn-primary">
                Enviar
            </button>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        $(document).on("mobileinit", function () {
            $.mobile.ignoreContentEnabled = true;
        });
    </script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js">
    </script>
    <script>
        chat_actual = null;
        chat_grupo_actual = null;
        offset = 0;
        $(document).ready(function () {
            obtenerMensajesNoVistos();
            setInterval(function () {
                obtenerMensajesNoVistos();
                abrir_chat(chat_actual, chat_grupo_actual);
            }, 6000);
        });
        function obtenerMensajesNoVistos() {
            url = '/ciudadano/ocio/amigos/chat/getSinVer';
            $.get(url, function (datos) {
                data = jQuery.parseJSON(datos);
                //console.log(data);
                if (data.estado === 'OK') {
                    $.each(data.message, function (k, v) {
                        $('#badge-' + v.ID).html(v.NUM_MENSAJES);
                        if (v.NUM_MENSAJES > 0) {
                            $('#badge-' + v.ID).show();
                        } else {
                            $('#badge-' + v.ID).hide();
                        }
                    });
                }
            });
        }
        function abrir_chat(id_usuario, id_grupo) {
            if (id_usuario !== null) {
                chat_actual = id_usuario;
                chat_grupo_actual = null;
                var url = '/ciudadano/getChat/' + chat_actual + '/' + null + '/' + offset;
            } else if (id_grupo !== null) {
                chat_grupo_actual = id_grupo;
                chat_actual = null;
                var url = '/ciudadano/getChat/' + null + '/' + chat_grupo_actual + '/' + offset;
            } else {
                chat_actual = null;
                chat_grupo_actual = null;
                var url = '/ciudadano/getChatComun';
            }
            $.get(url, function (data) {
                console.log(data);
                $('#panel-chat').empty();
                if (data.estado === 'OK') {
                    contenido = '';
                    $.each(data.mensajes, function (k, v) {
                        contenido += '<div class="col-xs-12" style="margin-top:1%;">';
                        if (v.usuario.alias === v.usuario.mi_alias) {
                            contenido += '<span class="mi-chat">';
                            contenido += '<p></p>';
                        } else {
                            contenido += '<span class="otro-chat">';
                            contenido += '<p><small>@' + v.usuario.alias + '</small></p>';
                        }
                        contenido += v.mensaje;
                        contenido += '<p style="text-align: right;"><small>' + v.fecha.date + '</small></p>';
                        contenido += '</span>';
                        contenido += '</div>';
                    });
                    $('#panel-chat').append(contenido);
                } else {
                    contenido = '';
                    contenido += '<div class="col-lg-12" style="margin-top:1%; background-color: #EBF8A4; padding: 15px; color:black;">';
                    contenido += '' + data.message;
                    contenido += '</div>';
                    $('#panel-chat').append(contenido);
                }
                $('#panel-chat-descripcion').empty();
                descripcion = '';
                if (id_usuario !== null || id_grupo !== null) {
                    if (typeof data.usuario !== 'undefined') {
                        if (data.usuario.imagen !== null) {
                            descripcion += '<img src="{{ asset('images/users/') }}' + data.usuario.dni + '/' + data.usuario.imagen + '" class="img-chat">';
                        } else {
                            descripcion += '<img src="{{ asset('images/fotos-usuarios/default.jpg') }}' + '" class="img-chat">';
                        }
                        descripcion += '<h1>Chat con @' + data.usuario.alias + '</h1>';
                    } else if (typeof data.distrito !== 'undefined') {
                        descripcion += '<h1>' + data.distrito.nombre + '</h1>';
                    }
                } else {
                    descripcion += '<h1>EL GUETO DE FENI</h1>';
                }
                $('#panel-chat-descripcion').append(descripcion);
                $("#panel-chat").animate({scrollTop: $(document).height() + 1000000}, "slow");
            });
        }

        $('#enviar').click(function () {
            var mensaje = $('#mensaje').val();
            if ($.trim(mensaje) !== '') {
                $('#enviar').html('Enviando...');
                $('#mensaje').val('');
                if (chat_actual !== null) {
                    datos = {'id_usuario': chat_actual, 'id_distrito': 0, 'comun': 0, 'mensaje': mensaje};
                } else if (chat_grupo_actual !== null) {
                    datos = {'id_usuario': 0, 'id_distrito': chat_grupo_actual, 'comun': 0, 'mensaje': mensaje};
                } else {
                    datos = {'id_usuario': 0, 'id_distrito': 0, 'comun': 1, 'mensaje': mensaje};
                }
                $.post('/ciudadano/enviarMensajeChat', datos, function (data) {
                    if (data.estado === 'OK') {
                        if (chat_actual !== null) {
                            abrir_chat(chat_actual, null);
                        } else if (chat_grupo_actual !== null) {
                            abrir_chat(null, chat_grupo_actual);
                        } else {
                            abrir_chat(null, null);
                        }
                    }
                });
                $('#enviar').html('Enviar');
            }
        });
    </script>
{% endblock %}