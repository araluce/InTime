{% extends "base.html.twig" %}

{% block header %}
    {% include "ciudadano/header.html.twig" %}
{% endblock %}

{% block stylesheets %}
    <style>
        .texto-personaje-cita{
            font-size: 50px;
            text-align: center;
        }
        .texto-personaje-autor{
            font-size: 30px;
            text-align: right;
        }
        .red-border{
            border-color: red;
        }
        .green-border{
            border-color: green;
        }
        .metronomista img{
            width: auto;
            height: 200px;
        }
        .prestamo{
            font-size: 41px;
        }
        legend{
            font-size: 35px;
        }
        .btn13,
        .btn4{
            border-style: solid;
            border-color: #000000;
        }
        .btn13{
            border-right: 6px;
        }

        .red-border,
        .green-border,
        .btn13,
        .btn4,
        .bordes{
            border-width: 2px;
        }
        .btn-block{
            font-size: 45px;
        }
        .bordes{
            border-radius: 15px;
        }
        #SD .slider-handle,
        #SH .slider-handle,
        #SM .slider-handle,
        #SS .slider-handle{
            position: absolute;
            top: 0;
            width: 60px;
            height: 60px;
        }
        #SD .slider-selection,
        #SH .slider-selection,
        #SM .slider-selection,
        #SS .slider-selection{
            background-color: #337ab7;
        }
        #SD .slider-track,
        #SH .slider-track,
        #SM .slider-track,
        #SS .slider-track{
            height: 30px;
            width: 100%;
            margin-top: -5px;
            top: 50%;
            left: 0;
        }
        @media (min-width: 1200px){
            .texto-personaje-cita{
                font-size: 25px;
            }
            .texto-personaje-autor{
                font-size: 20px;
            }
            .prestamo,
            legend{
                font-size: 14px;
            }
            .btn13{
                border-right: 2px;
            }
            .btn-block{
                font-size: 20px;
            }
            #SD .slider-handle,
            #SH .slider-handle,
            #SM .slider-handle,
            #SS .slider-handle{
                top: 0;
                width: 20px;
                height: 20px;
            }
            #SD .slider-track,
            #SH .slider-track,
            #SM .slider-track,
            #SS .slider-track{
                height: 10px;
                margin-top: -5px;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="btn-pref btn-group btn-group-justified btn-group-lg" style="margin-bottom: 1%;" role="group" aria-label="...">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary btn-menu-first" href="#tab1" data-toggle="tab">
                        <span class="fa fa-clock-o" aria-hidden="true"></span>
                        <div class="hidden-xs">IMPORTE</div>
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default btn-menu" href="#tab2" data-toggle="tab">
                        <span class="fa fa-refresh" aria-hidden="true"></span>
                        <div class="hidden-xs">EN CURSO</div>
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default btn-menu-last" onclick="window.history.back();" >
                        <span class="fa fa-arrow-left" aria-hidden="true"></span>
                        <div class="hidden-xs">ATRÁS</div>
                    </button>
                </div>
            </div>
            <div class="col-md-12">
                <div class="row">
                    <div class="tab-content">
                        <div class="tab-pane fade in active bordes" id="tab1">
                            <legend>Solicitar un préstamo</legend>
                            <p class="texto-personaje-cita">
                                Tipo de interés aplicable: <span id="interes"></span>
                            </p>
                            <div class="row after-slider" style="margin-top: 1%;">
                                <!--
                                <div class="col-xs-3">
                                    <div class="row">
                                        <div class="input-group">
                                            <input type="number" id="dias" class="form-control input-number" value="0" min="0" max="100" />
                                            <span class="input-group-addon">d</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-3">
                                    <div class="row">
                                        <div class="input-group">
                                            <input type="number" id="horas" class="form-control input-number" value="0" min="0" max="24" />
                                            <span class="input-group-addon">h</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-3">
                                    <div class="row">
                                        <div class="input-group">
                                            <input type="number" id="minutos" class="form-control input-number" value="0" min="0" max="60" />
                                            <span class="input-group-addon">m</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-3">
                                    <div class="row">
                                        <div class="input-group">
                                            <input type="number" id="segundos" class="form-control input-number" value="0" min="0" max="60" />
                                            <span class="input-group-addon">s</span>
                                        </div>
                                    </div>
                                </div>
                                -->

                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input type="number" id="dias" class="form-control" value="0" disabled/>
                                        <span class="input-group-addon">d</span>
                                    </div>
                                    <input id="slider-dias" style="margin-top: 2%;" type="number" data-slider-id="SD" data-slider-min="0" data-slider-max="7" data-slider-step="1" data-slider-value="0"/>
                                </div>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input type="number" id="horas" class="form-control" value="0" disabled/>
                                        <span class="input-group-addon">h</span>
                                    </div>
                                    <input id="slider-horas" style="margin-top: 2%;" type="number" data-slider-id="SH" data-slider-min="0" data-slider-max="23" data-slider-step="1" data-slider-value="0"/>
                                </div>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input type="number" id="minutos" class="form-control" value="0" disabled/>
                                        <span class="input-group-addon">m</span>
                                    </div>
                                    <input id="slider-minutos" style="margin-top: 2%;" type="number" data-slider-id="SM" data-slider-min="0" data-slider-max="59" data-slider-step="1" data-slider-value="0"/>
                                </div>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input type="number" id="segundos" class="form-control" value="0" disabled/>
                                        <span class="input-group-addon">s</span>
                                    </div>
                                    <input id="slider-segundos" style="margin-top: 2%;" type="number" data-slider-id="SS" data-slider-min="0" data-slider-max="59" data-slider-step="1" data-slider-value="0"/>
                                </div>
                            </div>
                            <div class="row" id='botones-solicitud'> </div>
                        </div>
                        <div class="tab-pane fade in" id="tab2">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        var dias = {'dias': 0, 'horas': 0, 'minutos': 0, 'segundos': 0};
        var TIEMPO_MAX_PRESTADO = 0;
        var TIEMPO_MAX_PRESTADO_FORMATO = {'dias': 0, 'horas': 0, 'minutos': 0, 'segundos': 0};
        $("#slider-dias").slider();
        $("#slider-dias").on("slide", function (slideEvt) {
            dias['dias'] = slideEvt.value;
            $("#dias").val(dias['dias']);
            if (dias['dias'] === 7) {
                $("#horas").val(0);
                $("#minutos").val(0);
                $("#segundos").val(0);
                dias['horas'] = 0;
                dias['minutos'] = 0;
                dias['segundos'] = 0;
            }
        });
        $("#slider-horas").slider();
        $("#slider-horas").on("slide", function (slideEvt) {
            if (dias['dias'] < 7) {
                dias['horas'] = slideEvt.value;
                $("#horas").val(dias['horas']);
            }
        });
        $("#slider-minutos").slider();
        $("#slider-minutos").on("slide", function (slideEvt) {
            if (dias['dias'] < 7) {
                dias['minutos'] = slideEvt.value;
                $("#minutos").val(dias['minutos']);
            }
        });
        $("#slider-segundos").slider();
        $("#slider-segundos").on("slide", function (slideEvt) {
            if (dias['dias'] < 7) {
                dias['segundos'] = slideEvt.value;
                $("#segundos").val(dias['segundos']);
            }
        });
        function solicitarPrestamo(bonificacion) {
            /*
             var dias = parseInt($("#dias").val());
             var horas = parseInt($("#horas").val());
             var minutos = parseInt($("#minutos").val());
             var segundos = parseInt($("#segundos").val());
             */
            var dias_p = dias['dias'];
            var horas_p = dias['horas'];
            var minutos_p = dias['minutos'];
            var segundos_p = dias['segundos'];
            tiempo = (((((dias_p * 24) + horas_p) * 60) + minutos_p) * 60 + segundos_p);
            if (tiempo <= 0) {
                mensaje = '<div class="metronomista col-lg-4">';
                mensaje += '  <center><img src="{{ asset('images/generic/personajes/Metronomista.png') }}"></center>';
                mensaje += '</div>';
                mensaje += '<div class="col-lg-8">';
                mensaje += '  <p class="texto-personaje-cita">No tengo tiempo que perder, solicita una cantidad y veremos qué podemos hacer</p>';
                mensaje += '  <p class="texto-personaje-autor">El metronomista</p>';
                mensaje += '</div>';
                mensaje += '  <div class="row">';
                mensaje += '    <div class="col-xs-4 col-xs-offset-4">';
                mensaje += '      <button class="btn btn-block btn-primary" onclick="location.reload();"> ACEPTAR </button>';
                mensaje += '    </div>';
                mensaje += '  </div>';
                $('#mensaje-texto').html(mensaje);
                $('#modal-avisos2').click();
            } else if (tiempo > TIEMPO_MAX_PRESTADO) {
                mensaje = '<div class="metronomista col-lg-4">';
                mensaje += '  <center><img src="{{ asset('images/generic/personajes/Metronomista.png') }}"></center>';
                mensaje += '</div>';
                mensaje += '<div class="col-lg-8">';
                mensaje += '  <p class="texto-personaje-cita">No puedo ofrecerte más de ' + TIEMPO_MAX_PRESTADO_FORMATO.dias + 'd ' + TIEMPO_MAX_PRESTADO_FORMATO.horas + 'h ' + TIEMPO_MAX_PRESTADO_FORMATO.minutos + 'm ' + TIEMPO_MAX_PRESTADO_FORMATO.segundos + 's</p>';
                mensaje += '  <p class="texto-personaje-autor">El metronomista</p>';
                mensaje += '</div>';
                mensaje += '  <div class="row">';
                mensaje += '    <div class="col-xs-4 col-xs-offset-4">';
                mensaje += '      <button class="btn btn-block btn-primary" onclick="location.reload();"> ACEPTAR </button>';
                mensaje += '    </div>';
                mensaje += '  </div>';
                $('#mensaje-texto').html(mensaje);
                $('#modal-avisos2').click();
            } else {
                var ruta = '/ciudadano/prestamos/solicitarPrestamo';
                var datos = { 'tiempo': tiempo, 'bonificacion': bonificacion };
                $.post(ruta, datos, function (data, status) {
                    mensaje = '<div class="metronomista col-lg-4">';
                    mensaje += '  <center><img src="{{ asset('images/generic/personajes/Metronomista.png') }}"></center>';
                    mensaje += '</div>';
                    mensaje += '<div class="col-lg-8">';
                    mensaje += '  <p class="texto-personaje-cita">' + data.message + '</p>';
                    mensaje += '  <p class="texto-personaje-autor">El metronomista</p>';
                    mensaje += '</div>';
                    mensaje += '  <div class="row">';
                    mensaje += '    <div class="col-xs-4 col-xs-offset-4">';
                    mensaje += '      <button class="btn btn-block btn-primary" onclick="location.reload();"> ACEPTAR </button>';
                    mensaje += '    </div>';
                    mensaje += '  </div>';
                    $('#mensaje-texto').html(mensaje);
                    $('#modal-avisos2').click();
                });
            }
        }
        function liquidarPrestamo(ID) {
            var ruta = '/ciudadano/prestamos/liquidarPrestamo';
            var datos = {
                'id': ID
            };
            $.post(ruta, datos, function (data, status) {
                mensaje = '<div class="metronomista col-lg-4">';
                mensaje += '  <center><img src="{{ asset('images/generic/personajes/Metronomista.png') }}"></center>';
                mensaje += '</div>';
                mensaje += '<div class="col-lg-8">';
                mensaje += '  <p class="texto-personaje-cita">' + data.message + '</p>';
                mensaje += '  <p class="texto-personaje-autor">El metronomista</p>';
                mensaje += '</div>';
                mensaje += '  <div class="row">';
                mensaje += '    <div class="col-xs-4 col-xs-offset-4">';
                mensaje += '      <button class="btn btn-block btn-primary" onclick="location.reload();"> ACEPTAR </button>';
                mensaje += '    </div>';
                mensaje += '  </div>';
                $('#mensaje-texto').html(mensaje);
                $('#modal-avisos2').click();
            });
        }

        function getPrestamos() {
            ruta = '/ciudadano/prestamos/getPrestamos';
            $.get(ruta, function (datos, status) {
                data = jQuery.parseJSON(datos);
                $('#interes').html(data.message.INTERES);
                TIEMPO_MAX_PRESTADO = data.message.TIEMPO_MAX_PRESTADO;
                TIEMPO_MAX_PRESTADO_FORMATO = data.message.TIEMPO_MAX_PRESTADO_FORMATO;
                contenido = '';
                if (data.message.BONIFICACION) {
                    contenido += '<div class="col-xs-6">';
                    contenido += '  <button class="btn btn-block btn-primary" style="margin-top: 2%" onclick="solicitarPrestamo(1);">USAR BONIFICACIÓN</button>';
                    contenido += '</div>';
                    contenido += '<div class="col-xs-6">';
                    contenido += '  <button class="btn btn-block btn-primary" style="margin-top: 2%" onclick="solicitarPrestamo(0);">SOLICITAR</button>';
                    contenido += '</div>';
                } else {
                    contenido += '<div class="col-xs-4 col-xs-offset-4">';
                    contenido += '  <button class="btn btn-block btn-primary" style="margin-top: 2%" onclick="solicitarPrestamo(0);">SOLICITAR</button>';
                    contenido += '</div>';
                }
                $('#botones-solicitud').html(contenido);
                $('#tab2').html('');
                $.each(data.message.DEUDAS, function (k, v) {
                    contenido = '';
                    if (v.ESTADO) {
                        contenido += '<div class="col-lg-12 bordes red-border prestamo" style="margin-bottom: 1%;">';
                    } else {
                        contenido += '<div class="col-lg-12 bordes green-border prestamo" style="margin-bottom: 1%;">';
                    }
                    contenido += '              <legend class="prestamo-detalle">ID #' + v.ID + '<i style="float: right;">' + v.FECHA.date + '</i></legend>';
                    contenido += '              <div class="col-lg-6">';
                    contenido += '                  <p>Importe solicitado: ' + v.CANTIDAD.dias + 'd ' + v.CANTIDAD.horas + 'h ' + v.CANTIDAD.minutos + 'm ' + v.CANTIDAD.segundos + 's</p>';
                    contenido += '                  <p><small>Interés aplicado: ' + v.INTERES + '</small></p>';
                    contenido += '                  <p>Pendiente de pago: ' + v.RESTANTE.dias + 'd ' + v.RESTANTE.horas + 'h ' + v.RESTANTE.minutos + 'm ' + v.RESTANTE.segundos + 's</p>';
                    contenido += '              </div>';
                    if (v.ESTADO) {
                        contenido += '              <div class="col-lg-6">';
                        contenido += '                  <div class="row">';
                        contenido += '                      <div class="col-xs-6 col-xs-offset-3">';
                        contenido += '                          <button class="btn btn-block btn-primary" onclick="liquidarPrestamo(' + v.ID + ');">';
                        contenido += '                              LIQUIDAR AHORA';
                        contenido += '                          </button>';
                        contenido += '                      </div>';
                        contenido += '                  </div>';
                        contenido += '              </div>';
                    }
                    contenido += '</div>';
                    $('#tab2').append(contenido);
                });
            });
        }
        $(document).ready(function () {
            getPrestamos();
            $(".btn-pref .btn").click(function () {
                $(".btn-pref .btn").removeClass("btn-primary").addClass("btn-default");
                $(this).removeClass("btn-default").addClass("btn-primary");
            });
        {% if info.message is defined or info.type is defined%} $('#box_modal_result').click();{% endif %}
        });
    </script>
{% endblock %}